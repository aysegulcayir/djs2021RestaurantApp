<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <link
            href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"
            rel="stylesheet"
        />
        <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
        <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
            crossorigin="anonymous"
        />
        <script
            src="https://kit.fontawesome.com/144f4e017a.js"
            crossorigin="anonymous"
        ></script>
        <title>Invoice</title>
    </head>

    <body>
        <div th:insert="fragments/navbar.html"></div>
        <div th:insert="fragments/modal.html"></div>

        <div class="container">
            <div class="jumbotron">
                <div class="page-content container">
                    <div class="page-header text-blue-d2">
                        <h1 class="page-title text-secondary-d1">
                            Invoice
                            <small class="page-info">
                                <i class="fa fa-angle-double-right text-80"></i>
                                ID: <span id="invoiceId"></span>
                            </small>
                        </h1>

                        <div class="page-tools">
                            <div class="action-buttons">
                                <a
                                    class="
                                        btn
                                        bg-white
                                        btn-light
                                        mx-1px
                                        text-95
                                    "
                                    href="#"
                                    data-title="Print"
                                >
                                    <i
                                        class="
                                            mr-1
                                            fa fa-print
                                            text-primary-m1 text-120
                                            w-2
                                        "
                                    ></i>
                                    Print
                                </a>
                                <a
                                    class="
                                        btn
                                        bg-white
                                        btn-light
                                        mx-1px
                                        text-95
                                    "
                                    href="#"
                                    data-title="PDF"
                                >
                                    <i
                                        class="
                                            mr-1
                                            fa fa-file-pdf-o
                                            text-danger-m1 text-120
                                            w-2
                                        "
                                    ></i>
                                    Export
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="container px-0">
                        <div class="row mt-4">
                            <div class="col-12 col-lg-10 offset-lg-1">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="text-center text-150">
                                            <i
                                                class="
                                                    fas
                                                    fa-file-invoice-dollar fa-5x
                                                "
                                            ></i>
                                        </div>
                                    </div>
                                </div>
                                <!-- .row -->

                                <hr class="row brc-default-l1 mx-n1 mb-4" />

                                <div class="row">
                                    <div class="col-sm-6">
                                        <div>To:</div>
                                        <div id="tableInfo"></div>
                                    </div>
                                    <!-- /.col -->

                                    <div
                                        class="
                                            text-95
                                            col-sm-6
                                            align-self-start
                                            d-sm-flex
                                            justify-content-end
                                        "
                                    >
                                        <hr class="d-sm-none" />
                                        <div class="text-grey-m2">
                                            <div
                                                class="
                                                    mt-1
                                                    mb-2
                                                    text-secondary-m1
                                                    text-600
                                                    text-125
                                                "
                                            >
                                                Invoice
                                            </div>

                                            <div class="my-2">
                                                <i
                                                    class="
                                                        fa fa-circle
                                                        text-blue-m2 text-xs
                                                        mr-1
                                                    "
                                                ></i>
                                                <span class="text-600 text-90"
                                                    >ID:</span
                                                >
                                                <span id="invoiceId-1"></span>
                                            </div>

                                            <div class="my-2">
                                                <i
                                                    class="
                                                        fa fa-circle
                                                        text-blue-m2 text-xs
                                                        mr-1
                                                    "
                                                ></i>
                                                <span class="text-600 text-90"
                                                    >Issue Date:</span
                                                >
                                                <span id="issueDate"></span>
                                            </div>

                                            <div class="my-2">
                                                <i
                                                    class="
                                                        fa fa-circle
                                                        text-blue-m2 text-xs
                                                        mr-1
                                                    "
                                                ></i>
                                                <span class="text-600 text-90"
                                                    >Status:</span
                                                >
                                                <span
                                                    class="
                                                        badge
                                                        badge-warning
                                                        badge-pill
                                                        px-25
                                                    "
                                                    >Unpaid</span
                                                >
                                            </div>
                                        </div>
                                    </div>
                                    <!-- /.col -->
                                </div>

                                <div class="mt-4">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Description</th>
                                                    <th>Qty</th>
                                                    <th>Unit Price</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>

                                            <tbody id="tableBody"></tbody>
                                        </table>
                                    </div>

                                    <div class="row mt-3">
                                        <div
                                            class="
                                                col-12 col-sm-7
                                                text-grey-d2 text-95
                                                mt-2 mt-lg-0
                                            "
                                        >
                                            Extra note such as company or
                                            payment information...
                                        </div>

                                        <div
                                            class="
                                                col-12 col-sm-5
                                                text-grey text-90
                                                order-first order-sm-last
                                            "
                                        >
                                            <div class="row my-2">
                                                <div class="col-7 text-right">
                                                    SubTotal
                                                </div>
                                                <div
                                                    id="subTotal"
                                                    class="col-5"
                                                ></div>
                                            </div>

                                            <div class="row my-2">
                                                <div class="col-7 text-right">
                                                    Tax (10%)
                                                </div>
                                                <div
                                                    id="tax"
                                                    class="col-5"
                                                ></div>
                                            </div>

                                            <div
                                                class="
                                                    row
                                                    my-2
                                                    align-items-center
                                                    bgc-primary-l3
                                                    p-2
                                                "
                                            >
                                                <div class="col-7 text-right">
                                                    Total Amount
                                                </div>
                                                <div
                                                    id="totalAmount"
                                                    class="col-5"
                                                ></div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr />

                                    <div>
                                        <span class="text-secondary-d1 text-105"
                                            >Thank you for your business</span
                                        >
                                        <button
                                            id="payBtn"
                                            class="
                                                btn btn-info btn-bold
                                                px-4
                                                float-right
                                                mt-3 mt-lg-0
                                            "
                                        >
                                            Pay Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"
        ></script>
        <script>
            let orderInfo;
            let menuInfo;
            let totalPrice;
            $(document).ready(async function () {
                let now = new Date($.now());
                await $.ajax({
                    type: "GET",
                    url: "/api/order/orderwhichwillbepaid",
                    success: function (response) {
                        orderInfo = response;
                    },
                });

                await $.ajax({
                    type: "GET",
                    url: "/api/menu",
                    success: function (response) {
                        menuInfo = response;
                    },
                });

                setOrderItemByItemToInvoince(
                    orderInfo.dishes,
                    menuInfo,
                    "tableBody",
                    "subTotal",
                    "tax",
                    "totalAmount",
                    10
                );
                setTableDetailToInvoice("tableInfo", orderInfo.table);
                $(`#invoiceId`).append(orderInfo.id);
                $(`#invoiceId-1`).append(orderInfo.id);
                $(`#issueDate`).append(
                    now.toLocaleDateString("en-US") +
                        " " +
                        now.toLocaleTimeString("en-US")
                );
            });

            $("#payBtn").click(function (e) {
                e.preventDefault();
                let paymentJsObj = {
                    order: orderInfo,
                    totalPrice,
                };
                $.ajax({
                    type: "POST",
                    url: "/api/payment",
                    data: JSON.stringify(paymentJsObj),
                    contentType: "application/json",
                    success: function (response) {
                        console.log(response);
                        pageRedirect("payment");
                    },
                });
            });

            function setTableDetailToInvoice(tableElId, tableObj) {
                let htmlEl = `
                            Table Number: ${tableObj.id}
                            Floor: ${tableObj.floor}`;
                $(`#${tableElId}`).append(htmlEl);
            }

            function setOrderItemByItemToInvoince(
                orderArr,
                menuArr,
                tableElId,
                subTotalElId,
                taxElId,
                totalAmountEl,
                taxRatio
            ) {
                let trElement = "";
                let priceOfProduct;
                let subTotal = 0;
                orderArr.forEach((element, index) => {
                    priceOfProduct = 0;
                    priceOfProduct = getPriceOfProduct(element.name, menuArr);
                    subTotal += priceOfProduct * element.quantity;
                    console.log(subTotal);
                    trElement += `  <tr>
                                        <td>${index + 1}</td>
                                        <td>${element.name}</td>
                                        <td>${element.quantity}</td>
                                        <td><i class="fas fa-euro-sign"></i> ${priceOfProduct}</td>
                                        <td><i class="fas fa-euro-sign"></i> ${formatMoney(
                                            priceOfProduct * element.quantity
                                        )}</td>
                                    </tr>`;
                });
                setAmountDetailToInvoice(
                    subTotalElId,
                    taxElId,
                    totalAmountEl,
                    subTotal,
                    taxRatio
                );
                $(`#${tableElId}`).append(trElement);
            }

            function setAmountDetailToInvoice(
                subTotalElId,
                taxElId,
                totalAmountEl,
                subTotal,
                taxRatio
            ) {
                let taxAmount = (subTotal * taxRatio) / 100;
                totalPrice = subTotal + taxAmount;
                $(`#${subTotalElId}`).append(
                    `<i class="fas fa-euro-sign" > ${formatMoney(subTotal)}</i>`
                );
                $(`#${taxElId}`).append(
                    `<i class="fas fa-euro-sign" > ${formatMoney(
                        taxAmount
                    )}</i>`
                );
                $(`#${totalAmountEl}`).append(
                    `<i class="fas fa-euro-sign" > ${formatMoney(
                        subTotal + taxAmount
                    )}</i>`
                );
            }

            function getPriceOfProduct(productName, priceArr) {
                let price = 0;
                priceArr.find((p) => {
                    console.log(p);
                    if (p.name == productName) {
                        price = p.price;
                    }
                });
                return formatMoney(price);
            }

            function formatMoney(amount) {
                return amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, "$&,");
            }

            function pageRedirect(pageName) {
                window.location.href = `./${pageName}`;
            }
        </script>
    </body>
</html>
